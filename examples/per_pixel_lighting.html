<html>
	<head>
		<title>CrimildJS</title>
        <script data-main="../src/crimild" src="../lib/require.js"></script>
        <script id="shader-fs" type="x-shader/x-fragment">
        	precision mediump float;

            uniform bool uUseLighting;
            uniform vec4 uLightPosition;
            uniform vec3 uLightAmbient;
            uniform vec3 uLightDiffuse;
            uniform vec3 uLightSpecular;
            uniform float uLightShininess;

            varying vec3 vEyespaceNormal;
        	
        	void main(void) {
                if (!uUseLighting) {
                    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
                }
                else {
                    vec3 N = normalize(vEyespaceNormal);
                    vec3 L = normalize(uLightPosition.xyz);
                    vec3 E = vec3(0, 0, 1);
                    vec3 H = normalize(L + E);

                    float df = max(0.0, dot(N, L));
                    float sf = max(0.0, dot(N, H));
                    sf = pow(sf, uLightShininess);

                    vec3 color = uLightAmbient + df * uLightDiffuse + sf * uLightSpecular;
                    gl_FragColor = vec4(color, 1);
                }
        	}
        </script>
        <script id="shader-vs" type="x-shader/x-vertex">
        	attribute vec3 aVertexPosition;
            attribute vec3 aVertexNormal;

        	uniform mat4 uMVMatrix;
        	uniform mat4 uPMatrix;
            uniform mat3 uNMatrix;

            varying vec3 vEyespaceNormal;

        	void main(void) {
                vEyespaceNormal = uNMatrix * aVertexNormal;
                gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
        	}
        </script>
		<script type="text/javascript">
			function initCrimild(canvasId) {
                require(["crimild"], function(crimild) {
                    var scene = crimild.core.groupNode({
                        name: "scene",
                        nodes: [
                            crimild.core.geometryNode({
                                name: "a cone",
                                primitives: [
                                    crimild.primitives.kleinBottlePrimitive({
                                        type: crimild.core.primitive.types.TRIANGLES,
                                        vertexFormat: crimild.core.vertexFormat({normals: 3}),
                                        scale: 0.15
                                    })
                                ]
                            })
                        ],
                        local: crimild.math.transformation({
                            translate: [0, 0, -5],
                        }),
                        components: [
                            function() {
                                var that = crimild.core.nodeComponent({name: "update"});
                                var angle = 0.0;

                                that.update = function() {
                                    scene.local.rotate = quat4.fromAngleAxis(angle, [0, 1, 0])
                                    scene.perform(crimild.core.worldStateUpdate());
                                    angle += 0.01;
                                };

                                return that;
                            }(),
                            crimild.components.rotationComponent({angle: 0.01, axis: [0, 1, 0]}),
                            crimild.rendering.renderComponent({
                                effects: [
                                    crimild.rendering.effect({
                                        shaderProgram: crimild.rendering.shaderProgram({
                                            vertexShader: crimild.rendering.shader({
                                                scriptId: "shader-vs"
                                            }),
                                            fragmentShader: crimild.rendering.shader({
                                                scriptId: "shader-fs"
                                            })
                                        })
                                    })
                                ],
                                lights: [
                                    crimild.rendering.light({
                                        diffuse: [0.75, 0.0, 0.0],
                                        position: [5, 0.25, 3.0, 1.0]
                                    })
                                ]
                            })
                        ]
                    });

                    var canvas = document.getElementById(canvasId);
                    crimild.simulation.run({canvas: canvas, scene: scene});
                });
			}
		</script>
	</head>
	<body onload="initCrimild('webGLCanvas');">
    	<div align="center">
            <h1>Crimild JS Demo: Per Pixel Lighting</h1>
            <canvas id="webGLCanvas" style="border: none;" width="800" height="600">
    	       Your browser does not support WebGL
            </canvas>
        </div>
	</body>
</html>