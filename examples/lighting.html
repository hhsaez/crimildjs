<html>
	<head>
		<title>CrimildJS</title>
        <script data-main="../src/crimild" src="../lib/require.js"></script>
        <script id="shader-fs" type="x-shader/x-fragment">
        	precision mediump float;

            varying vec3 vLightWeighting;
        	
        	void main(void) {
                gl_FragColor = vec4(vLightWeighting, 1.0);
        	}
        </script>
        <script id="shader-vs" type="x-shader/x-vertex">
        	attribute vec3 aVertexPosition;
            attribute vec3 aVertexNormal;

        	uniform mat4 uMVMatrix;
        	uniform mat4 uPMatrix;
            uniform mat3 uNMatrix;

            uniform vec3 uAmbientColor;
            uniform vec3 uLightingDirection;
            uniform vec3 uDirectionalColor;
            uniform bool uUseLighting;

            varying vec3 vLightWeighting;

        	void main(void) {
        		gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);

                if (!uUseLighting) {
                    vLightWeighting = vec3(1.0, 1.0, 1.0);
                }
                else {
                    vec3 transformedNormal = uNMatrix * aVertexNormal;
                    float directionalLightWeighting = max(dot(transformedNormal, uLightingDirection), 0.0);
                    vLightWeighting = uAmbientColor + uDirectionalColor * directionalLightWeighting;
                }
        	}
        </script>
		<script type="text/javascript">
			function initCrimild(canvasId) {
                require(["crimild"], function(crimild) {
                    var scene = crimild.core.groupNode({
                        name: "scene",
                        nodes: [
                            crimild.core.geometryNode({
                                name: "a cone",
                                primitives: [
                                    crimild.primitives.kleinBottlePrimitive({
                                        type: crimild.core.primitive.types.TRIANGLES,
                                        vertexFormat: crimild.core.vertexFormat({normals: 3}),
                                        scale: 0.15
                                    })
                                ]
                            })
                        ],
                        local: crimild.math.transformation({
                            translate: [0, 0, -5],
                        })
                    });

                    scene.updateComponent = function(spec) {
                        var that = crimild.core.nodeComponent(spec);
                        var angle = 0.0;

                        that.update = function() {
                            scene.local.rotate = quat4.fromAngleAxis(angle, [0, 1, 0])
                            scene.perform(crimild.core.worldStateUpdate());
                            angle += 0.01;
                        };

                        return that;
                    }();

                    scene.renderComponent = crimild.rendering.renderComponent({
                        effects: [
                            crimild.rendering.effect({
                                shaderProgram: crimild.rendering.shaderProgram({
                                    vertexShader: crimild.rendering.shader({
                                        scriptId: "shader-vs"
                                    }),
                                    fragmentShader: crimild.rendering.shader({
                                        scriptId: "shader-fs"
                                    })
                                })
                            })
                        ],
                        lights: [
                            crimild.rendering.light({
                                directionalColor: [1, .3, 0],
                                direction: [-5, 0, 0]
                            })
                        ]
                    });

                    var canvas = document.getElementById(canvasId);
                    crimild.simulation.run({canvas: canvas, scene: scene});
                });
			}
		</script>
	</head>
	<body onload="initCrimild('webGLCanvas');">
    	<div align="center">
            <h1>Crimild JS Demo: Vertex Lighting</h1>
            <canvas id="webGLCanvas" style="border: none;" width="800" height="600">
    	       Your browser does not support WebGL
            </canvas>
        </div>
	</body>
</html>